<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proses Penilaian - Audio Submissions</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 14px;
            opacity: 0.9;
        }

        .submission-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .submission-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }

        .submission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .task-info {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-processing {
            background: #cfe2ff;
            color: #084298;
        }

        .status-graded {
            background: #d1e7dd;
            color: #0f5132;
        }

        .audio-controls {
            margin: 15px 0;
        }

        .audio-player {
            width: 100%;
            margin-bottom: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .grading-result {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .score-display {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 20px 0;
        }

        .feedback-text {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.6;
            color: #495057;
        }

        .criteria-list {
            margin-top: 15px;
        }

        .criterion {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: white;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .criterion-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .criterion-score {
            font-weight: bold;
            color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .process-all-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 30px;
            font-size: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
        }

        .process-all-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }

        .auto-save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #d1e7dd;
            color: #0f5132;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Proses Penilaian Audio</h1>
            <p>Sistem penilaian otomatis untuk submission audio murid</p>
        </div>

        <div class="content">
            <div class="section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number" id="totalSubmissions">0</div>
                        <div class="label">Total Tugas</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="pendingGrading">0</div>
                        <div class="label">Menunggu Penilaian</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="gradedSubmissions">0</div>
                        <div class="label">Sudah Diperiksa</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="averageScore">0</div>
                        <div class="label">Nilai Rata-rata</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">üìù Submissions</div>
                <div id="submissionsList"></div>
            </div>
        </div>
    </div>

    <button class="process-all-btn" onclick="processAllPending()">
        ‚ö° Proses Semua yang Pending
    </button>

    <div class="auto-save-indicator" id="autoSaveIndicator">
        ‚úì Tersimpan otomatis
    </div>

    <script>
        // Config - align with index.html / guru.html
        const CONFIG = {
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzQgwtCqFyv8HCq-NozSukODp7Oytf3dCKANJzgBSbGdth9iscsnKIlHbZWF0cMcmRG/exec'
        };

        // Submissions will be loaded from Apps Script
        let submissions = [];

        // Load submissions from server
        async function loadSubmissions() {
            try {
                const resp = await fetch(CONFIG.APPS_SCRIPT_URL + '?action=getSubmissions');
                const data = await resp.json();
                if (data.success && Array.isArray(data.submissions)) {
                    // Map server fields to local format expected by this page
                    submissions = data.submissions.map(s => ({
                        id: s.id || s.submissionId || s.rowId,
                        timestamp: s.waktu || s.waktu || s.timestamp || s.time,
                        taskCode: s.kodeTask || s.taskCode,
                        studentName: s.nama || s.namaMurid || s.studentName,
                        class: s.kelas || s.class || s.kelasSiswa,
                        absen: s.absen || s.absen || s.noAbsen,
                        subject: s.mapel || s.subject,
                        taskTitle: s.judul || s.taskTitle,
                        studentNote: s.catatan || s.note || s.studentNote,
                        audioLink: s.audioUrl || s.audio || s.audioLink,
                        duration: s.durasi || s.duration || s.durasiDetik,
                        fileSize: s.ukuran || s.ukuran || s.fileSize,
                        format: s.format || 'MP3',
                        status: s.status || (s.nilai ? 'Sudah Diperiksa' : 'Belum Diperiksa'),
                        score: s.nilai || s.score || null,
                        feedback: s.feedback || null,
                        teacherName: s.guru || s.teacherName || null,
                        gradingTime: s.waktuPenilaian || s.gradingTime || null,
                        rowIndex: s.rowIndex
                    }));
                } else {
                    submissions = [];
                }
            } catch (err) {
                console.error('Error loading submissions:', err);
                submissions = [];
            }
        }

        function updateStats() {
            const total = submissions.length;
            const pending = submissions.filter(s => s.status === "Belum Diperiksa").length;
            const graded = submissions.filter(s => s.status === "Sudah Diperiksa").length;
            const scores = submissions.filter(s => s.score !== null).map(s => s.score);
            const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;

            document.getElementById('totalSubmissions').textContent = total;
            document.getElementById('pendingGrading').textContent = pending;
            document.getElementById('gradedSubmissions').textContent = graded;
            document.getElementById('averageScore').textContent = avgScore;
        }

        function renderSubmissions() {
            const container = document.getElementById('submissionsList');
            
            if (submissions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>Belum ada submissions</h3>
                        <p>Submissions dari murid akan muncul di sini</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = submissions.map(sub => `
                <div class="submission-card">
                    <div class="submission-header">
                        <div class="student-info">
                            <div class="student-name">${sub.studentName}</div>
                            <div class="task-info">
                                ${sub.class} - No. ${sub.absen} | ${sub.subject} - ${sub.taskTitle}
                            </div>
                            <div class="task-info">
                                ‚è±Ô∏è ${sub.duration}s | üì¶ ${sub.fileSize} KB | üéµ ${sub.format}
                            </div>
                        </div>
                        <span class="status-badge ${sub.status === 'Sudah Diperiksa' ? 'status-graded' : (sub.status === 'Sedang Diproses' ? 'status-processing' : 'status-pending')}">
                            ${sub.status}
                        </span>
                    </div>

                    ${sub.studentNote ? `
                        <div style="background: #e7f3ff; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 14px; color: #004085;">
                            üí¨ <strong>Catatan:</strong> ${sub.studentNote}
                        </div>
                    ` : ''}

                    <div class="audio-controls">
                        <audio class="audio-player" controls>
                            <source src="${convertDriveUrl(sub.audioLink)}" type="audio/mpeg">
                            Browser Anda tidak mendukung audio player.
                        </audio>
                    </div>

                    ${sub.status === 'Belum Diperiksa' ? `
                        <button class="btn btn-primary" onclick="gradeSubmission('${sub.id}')">
                            ü§ñ Proses & Nilai dengan AI
                        </button>
                    ` : `
                        <div class="grading-result">
                            <div class="score-display">${sub.score}/100</div>
                            <div class="feedback-text">
                                <strong>üìù Feedback:</strong><br>
                                ${sub.feedback}
                            </div>
                            <div style="margin-top: 15px; font-size: 13px; color: #666;">
                                üë®‚Äçüè´ Dinilai oleh: ${sub.teacherName || 'Sistem AI'} | 
                                üïê ${sub.gradingTime}
                            </div>
                            <button class="btn btn-secondary" onclick="regradeSubmission('${sub.id}')" style="margin-top: 15px;">
                                üîÑ Nilai Ulang
                            </button>
                        </div>
                    `}
                </div>
            `).join('');
        }

        async function gradeSubmission(submissionId) {
            const submission = submissions.find(s => s.id === submissionId);
            if (!submission) return;

            // Update status to processing
            submission.status = "Sedang Diproses";
            renderSubmissions();

            // Simulate AI processing (In real implementation, this would call Claude API)
            await new Promise(resolve => setTimeout(resolve, 2000));

            // Generate AI-based grading
            const grading = await generateAIGrading(submission);

            // Update submission with grading
            submission.status = "Sudah Diperiksa";
            submission.score = grading.score;
            submission.feedback = grading.feedback;
            submission.teacherName = "Sistem AI";
            submission.gradingTime = new Date().toLocaleString('id-ID');

            // Show auto-save indicator
            showAutoSave();

            // Persist grading to server (if rowIndex/submissionId available)
            try {
                const payload = {
                    type: 'grading',
                    submissionId: submission.id,
                    rowIndex: submission.rowIndex,
                    nilai: submission.score,
                    feedback: submission.feedback,
                    guru: submission.teacherName,
                    waktuPenilaian: new Date().toISOString()
                };

                await fetch(CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            } catch (err) {
                console.error('Failed to save grading to server:', err);
            }

            // Update UI
            updateStats();
            renderSubmissions();
        }

        async function generateAIGrading(submission) {
            // Simulated AI grading - In real implementation, this would use Claude API
            // to analyze the audio content, pronunciation, fluency, content quality, etc.
            
            const criteria = {
                pronunciation: Math.floor(Math.random() * 20) + 75, // 75-95
                fluency: Math.floor(Math.random() * 20) + 70,       // 70-90
                content: Math.floor(Math.random() * 20) + 75,       // 75-95
                vocabulary: Math.floor(Math.random() * 20) + 70,    // 70-90
                grammar: Math.floor(Math.random() * 20) + 75        // 75-95
            };

            const score = Math.round(
                (criteria.pronunciation + criteria.fluency + criteria.content + 
                 criteria.vocabulary + criteria.grammar) / 5
            );

            const feedbacks = [
                `Sangat bagus! Pronunciasi jelas dan mudah dipahami. Konten terstruktur dengan baik. Untuk perbaikan: tingkatkan variasi vocabulary dan cobalah berbicara dengan lebih natural.`,
                `Baik sekali! Penyampaian lancar dan konten relevan dengan topik. Yang perlu ditingkatkan: perhatikan intonasi dan jeda antar kalimat agar lebih natural.`,
                `Cukup baik! Ada beberapa kesalahan kecil dalam pronunciasi namun secara keseluruhan dapat dipahami. Tingkatkan: kelancaran berbicara dan struktur kalimat.`,
                `Excellent work! Clear pronunciation, good fluency, dan konten yang komprehensif. Terus pertahankan dan tingkatkan vocabulary range.`
            ];

            return {
                score: score,
                feedback: feedbacks[Math.floor(Math.random() * feedbacks.length)],
                criteria: criteria
            };
        }

        // Convert Google Drive sharing URL to direct download playable URL
        function convertDriveUrl(url) {
            if (!url) return '#';
            if (url.includes('drive.google.com/uc?')) return url;
            let fileId = null;
            const match1 = url.match(/\/file\/d\/([^\/]+)/);
            if (match1) fileId = match1[1];
            const match2 = url.match(/[?&]id=([^&]+)/);
            if (match2) fileId = match2[1];
            if (fileId) return `https://drive.google.com/uc?export=download&id=${fileId}`;
            return url;
        }

        async function regradeSubmission(submissionId) {
            if (confirm('Apakah Anda yakin ingin menilai ulang submission ini?')) {
                const submission = submissions.find(s => s.id === submissionId);
                submission.status = "Belum Diperiksa";
                submission.score = null;
                submission.feedback = null;
                updateStats();
                renderSubmissions();
            }
        }

        async function processAllPending() {
            const pending = submissions.filter(s => s.status === "Belum Diperiksa");
            
            if (pending.length === 0) {
                alert('Tidak ada submission yang perlu dinilai!');
                return;
            }

            if (!confirm(`Proses ${pending.length} submission? Ini mungkin memakan waktu beberapa menit.`)) {
                return;
            }

            for (const submission of pending) {
                await gradeSubmission(submission.id);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Delay between processing
            }

            alert('Semua submission berhasil dinilai!');
        }

        function showAutoSave() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        // Initialize: load from server then render
        (async () => {
            await loadSubmissions();
            updateStats();
            renderSubmissions();
        })();

        // Auto-refresh every 30 seconds: reload submissions
        setInterval(async () => {
            await loadSubmissions();
            updateStats();
            renderSubmissions();
        }, 30000);
    </script>
</body>
</html>
