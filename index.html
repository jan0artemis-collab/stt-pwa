<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>STT Sekolah</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0d6efd">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
    }
    h2 {
      text-align: center;
      color: #0d6efd;
    }
    .form-group {
      margin-bottom: 12px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: bold;
      color: #333;
    }
    input, select, button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background: #0d6efd;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 8px;
      font-weight: bold;
    }
    button:hover {
      background: #0b5ed7;
    }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .stop {
      background: #dc3545;
    }
    .stop:hover {
      background: #bb2d3b;
    }
    .status {
      padding: 12px;
      margin: 12px 0;
      border-radius: 4px;
      text-align: center;
      font-weight: bold;
    }
    .recording {
      background: #fff3cd;
      color: #856404;
      border: 2px solid #ffc107;
    }
    .ready {
      background: #d1e7dd;
      color: #0f5132;
      border: 2px solid #198754;
    }
    .info {
      background: #cfe2ff;
      color: #084298;
      border: 2px solid #0d6efd;
      font-size: 14px;
      margin-top: 8px;
    }
    audio {
      width: 100%;
      margin-top: 12px;
    }
  </style>
</head>
<body>

<h2>üéôÔ∏è STT Sekolah</h2>

<div class="form-group">
  <label for="nama">Nama Guru:</label>
  <input id="nama" placeholder="Masukkan nama guru">
</div>

<div class="form-group">
  <label for="kegiatan">Jenis Kegiatan:</label>
  <select id="kegiatan">
    <option value="Pembelajaran">Pembelajaran</option>
    <option value="Rapat">Rapat</option>
    <option value="Refleksi">Refleksi</option>
    <option value="Lainnya">Lainnya</option>
  </select>
</div>

<div id="statusDiv"></div>

<button id="btnMulai" onclick="mulaiRekam()">üéôÔ∏è Mulai Rekam</button>
<button id="btnHenti" class="stop" onclick="hentiRekam()" disabled>‚èπÔ∏è Hentikan</button>

<audio id="audioPlayer" controls style="display:none"></audio>

<button id="btnSimpan" onclick="simpan()" disabled>üíæ Simpan ke Spreadsheet</button>

<div class="info" id="infoSize"></div>

<script>
let mediaRecorder;
let audioChunks = [];
let audioBlob = null;

async function mulaiRekam() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    
    // Gunakan codec yang paling efisien
    let options = { mimeType: 'audio/webm;codecs=opus' };
    
    // Fallback jika opus tidak didukung
    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
      options = { mimeType: 'audio/webm' };
      if (!MediaRecorder.isTypeSupported(options.mimeType)) {
        options = { mimeType: 'audio/mp4' };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
          options = { mimeType: '' }; // Default browser
        }
      }
    }
    
    mediaRecorder = new MediaRecorder(stream, options);
    audioChunks = [];
    
    mediaRecorder.ondataavailable = event => {
      audioChunks.push(event.data);
    };
    
    mediaRecorder.onstop = async () => {
      audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
      
      // Tampilkan audio player
      const audioURL = URL.createObjectURL(audioBlob);
      const player = document.getElementById('audioPlayer');
      player.src = audioURL;
      player.style.display = 'block';
      
      // Tampilkan ukuran file
      const sizeKB = (audioBlob.size / 1024).toFixed(2);
      document.getElementById('infoSize').textContent = `Ukuran audio: ${sizeKB} KB`;
      
      document.getElementById('btnSimpan').disabled = false;
      document.getElementById('statusDiv').innerHTML = '<div class="ready">‚úÖ Rekaman siap disimpan</div>';
      
      // Hentikan stream
      stream.getTracks().forEach(track => track.stop());
    };
    
    mediaRecorder.start();
    
    document.getElementById('btnMulai').disabled = true;
    document.getElementById('btnHenti').disabled = false;
    document.getElementById('btnSimpan').disabled = true;
    document.getElementById('statusDiv').innerHTML = '<div class="recording">üî¥ Sedang merekam...</div>';
    
  } catch (err) {
    alert('Gagal mengakses mikrofon: ' + err.message);
  }
}

function hentiRekam() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
    document.getElementById('btnMulai').disabled = false;
    document.getElementById('btnHenti').disabled = true;
  }
}

async function simpan() {
  const nama = document.getElementById('nama').value.trim();
  const kegiatan = document.getElementById('kegiatan').value;
  
  if (!nama) {
    alert('Nama guru harus diisi!');
    return;
  }
  
  if (!audioBlob) {
    alert('Belum ada rekaman audio!');
    return;
  }
  
  document.getElementById('btnSimpan').disabled = true;
  document.getElementById('statusDiv').innerHTML = '<div class="info">‚è≥ Mengirim data...</div>';
  
  try {
    // Konversi audio blob ke base64
    const reader = new FileReader();
    reader.readAsDataURL(audioBlob);
    
    reader.onloadend = async () => {
      const base64Audio = reader.result.split(',')[1]; // Hapus prefix data:audio/...;base64,
      
      const response = await fetch('https://script.google.com/macros/s/AKfycbzj6ZnyfJvZ_o7ILQoiW1HO89w3QxXrMH_zv5i90E9v9z4B1E0yvJif4w_GtEbWlDZnZQ/exec', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          nama: nama,
          kegiatan: kegiatan,
          audio: base64Audio,
          mimeType: audioBlob.type,
          ukuran: audioBlob.size,
          waktu: new Date().toISOString()
        })
      });
      
      if (response.ok) {
        alert('‚úÖ Data berhasil disimpan!');
        // Reset form
        document.getElementById('nama').value = '';
        document.getElementById('kegiatan').value = 'Pembelajaran';
        document.getElementById('audioPlayer').style.display = 'none';
        document.getElementById('infoSize').textContent = '';
        document.getElementById('statusDiv').innerHTML = '';
        audioBlob = null;
      } else {
        throw new Error('Response tidak OK');
      }
    };
    
  } catch (err) {
    alert('‚ùå Gagal menyimpan data: ' + err.message);
    document.getElementById('btnSimpan').disabled = false;
  }
}

// Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
</script>

</body>
</html>