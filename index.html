<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Tugas Voice - Murid</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#667eea">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 500px;
      width: 100%;
      padding: 32px;
    }
    .header {
      text-align: center;
      margin-bottom: 32px;
    }
    .header h1 {
      color: #667eea;
      font-size: 28px;
      margin-bottom: 8px;
    }
    .header p {
      color: #666;
      font-size: 14px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }
    label .required {
      color: #e74c3c;
      margin-left: 2px;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      font-size: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      transition: all 0.3s;
      font-family: inherit;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
    }
    button {
      width: 100%;
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-record {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-record:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }
    .btn-stop {
      background: #e74c3c;
      color: white;
    }
    .btn-stop:hover:not(:disabled) {
      background: #c0392b;
      transform: translateY(-2px);
    }
    .btn-submit {
      background: #27ae60;
      color: white;
    }
    .btn-submit:hover:not(:disabled) {
      background: #229954;
      transform: translateY(-2px);
    }
    .btn-logout {
      background: #95a5a6;
      color: white;
      padding: 10px;
      font-size: 14px;
    }
    .status-box {
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      text-align: center;
      font-weight: 600;
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .status-recording {
      background: #fff3cd;
      color: #856404;
      border: 2px solid #ffc107;
    }
    .status-ready {
      background: #d1e7dd;
      color: #0f5132;
      border: 2px solid #198754;
    }
    .status-info {
      background: #cfe2ff;
      color: #084298;
      border: 2px solid #0d6efd;
    }
    .audio-player {
      margin: 16px 0;
      width: 100%;
      border-radius: 8px;
      display: none;
    }
    .audio-player.show {
      display: block;
    }
    .info-chip {
      display: inline-block;
      background: #f0f0f0;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      color: #666;
      margin-top: 12px;
    }
    .timer {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
      text-align: center;
      margin: 16px 0;
      font-family: 'Courier New', monospace;
    }
    .wave-animation {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      height: 40px;
      margin: 16px 0;
    }
    .wave-bar {
      width: 4px;
      background: #667eea;
      border-radius: 4px;
      animation: wave 1s ease-in-out infinite;
    }
    .wave-bar:nth-child(2) { animation-delay: 0.1s; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; }
    .wave-bar:nth-child(4) { animation-delay: 0.3s; }
    .wave-bar:nth-child(5) { animation-delay: 0.4s; }
    @keyframes wave {
      0%, 100% { height: 10px; }
      50% { height: 30px; }
    }
    .login-container {
      display: none;
    }
    .login-container.active {
      display: block;
    }
    .main-form {
      display: none;
    }
    .main-form.active {
      display: block;
    }
    .user-badge {
      background: #e8f4f8;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .user-info {
      font-size: 14px;
      color: #333;
    }
    .user-info strong {
      color: #667eea;
    }
  </style>
</head>
<body>

<div class="container">
  <!-- LOGIN SECTION -->
  <div id="loginSection" class="login-container active">
    <div class="header">
      <h1>üé§ Portal Murid</h1>
      <p>Masukkan kode tugas dari guru Anda</p>
    </div>

    <div class="form-group">
      <label for="kodeAccess">Kode Tugas<span class="required">*</span></label>
      <input id="kodeAccess" type="text" placeholder="Contoh: MTK-AVIS-7A-AB12-XY34" style="text-transform: none;">
      <div style="margin-top: 8px; font-size: 13px; color: #666;">
        üí° Masukkan kode yang diberikan oleh guru
      </div>
    </div>

    <button onclick="verifyCode()" class="btn-submit">üîê Masuk</button>

    <div style="margin-top: 20px; padding: 12px; background: #fff3cd; border-radius: 8px; font-size: 13px; color: #856404;">
      üí° <strong>Tip:</strong> Minta kode tugas kepada guru mata pelajaran Anda
    </div>
  </div>

  <!-- MAIN FORM SECTION -->
  <div id="mainSection" class="main-form">
    <div class="header">
      <h1>üé§ Pengumpulan Tugas Voice</h1>
      <p>Rekam jawaban Anda dan kirim ke Guru</p>
    </div>

    <div class="user-badge">
      <div>
        <div class="user-info">
          <strong>üìö Mapel:</strong> <span id="infoMapel"></span>
        </div>
        <div class="user-info">
          <strong>üìù Tugas:</strong> <span id="infoTugas"></span>
        </div>
      </div>
      <button class="btn-logout" onclick="logout()">Keluar</button>
    </div>

    <div style="background: #e8f4f8; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0d6efd;">
      <strong style="color: #084298;">üìã Instruksi Tugas:</strong>
      <p id="infoMateri" style="margin-top: 8px; color: #333; line-height: 1.6;"></p>
    </div>

    <div class="form-group">
      <label for="nama">Nama Lengkap<span class="required">*</span></label>
      <input id="nama" type="text" placeholder="Contoh: Budi Santoso">
    </div>

    <div class="grid-2">
      <div class="form-group">
        <label for="kelas">Kelas<span class="required">*</span></label>
        <select id="kelas">
          <option value="">Pilih Kelas</option>
          <option value="7A">7A</option>
          <option value="7B">7B</option>
          <option value="7C">7C</option>
          <option value="8A">8A</option>
          <option value="8B">8B</option>
          <option value="8C">8C</option>
          <option value="9A">9A</option>
          <option value="9B">9B</option>
          <option value="9C">9C</option>
        </select>
      </div>

      <div class="form-group">
        <label for="absen">No. Absen<span class="required">*</span></label>
        <input id="absen" type="number" min="1" max="50" placeholder="1-50">
      </div>
    </div>

    <!-- HIDDEN FIELDS - Auto filled from code -->
    <input type="hidden" id="mapel">
    <input type="hidden" id="judul">
    <input type="hidden" id="catatan">
    <input type="hidden" id="namaGuru">

    <div id="statusDiv"></div>
    <div id="timerDiv"></div>
    <div id="waveDiv"></div>

    <button id="btnMulai" class="btn-record" onclick="mulaiRekam()">
      üéôÔ∏è Mulai Rekam
    </button>
    <button id="btnHenti" class="btn-stop" onclick="hentiRekam()" disabled>
      ‚èπÔ∏è Hentikan Rekaman
    </button>

    <audio id="audioPlayer" class="audio-player" controls></audio>

    <button id="btnKirim" class="btn-submit" onclick="kirimTugas()" disabled>
      üì§ Kirim ke Guru
    </button>

    <div id="infoDiv"></div>
  </div>
</div>

<script>
// KONFIGURASI - Ganti URL Google Apps Script Anda
const CONFIG = {
  APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwbW3_GczXDMbQN0spD_VGDqtBVbOj7a035MWvBa7Lt8fFzu6E1CX6uyGAsFb_HVXTj/exec'
};

// State management (in memory, tidak pakai localStorage)
let currentUser = {
  kodeTask: null,
  taskData: null,
  authenticated: false
};

let mediaRecorder;
let audioChunks = [];
let audioBlob = null;
let timerInterval;
let recordingSeconds = 0;

// === VERIFY TASK CODE ===
async function verifyCode() {
  const kodeInput = document.getElementById('kodeAccess').value.trim().toUpperCase();
  
  if (!kodeInput) {
    alert('‚ùå Masukkan kode tugas!');
    return;
  }
  
  // Show loading
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '‚è≥ Memverifikasi kode...';
  
  try {
    // Verify code from server
    const response = await fetch(CONFIG.APPS_SCRIPT_URL + '?action=verifyTask&code=' + encodeURIComponent(kodeInput));
    const data = await response.json();
    
    if (data.success && data.taskData) {
      // Code valid, load task data
      currentUser.kodeTask = kodeInput;
      currentUser.taskData = data.taskData;
      currentUser.authenticated = true;
      
      // Show main form with auto-filled data
      showMainForm();
    } else {
      alert('‚ùå Kode tugas tidak valid atau sudah kadaluarsa! Periksa kembali kode dari guru Anda.');
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  } catch (error) {
    console.error('Error verifying code:', error);
    alert('‚ùå Gagal memverifikasi kode. Pastikan koneksi internet Anda stabil.');
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

function showMainForm() {
  const task = currentUser.taskData;
  
  // Hide login, show main form
  document.getElementById('loginSection').classList.remove('active');
  document.getElementById('mainSection').classList.add('active');
  
  // Fill task info
  document.getElementById('infoMapel').textContent = task.mapel;
  document.getElementById('infoTugas').textContent = task.judulTugas;
  document.getElementById('infoMateri').textContent = task.materi;
  
  // Set hidden fields
  document.getElementById('mapel').value = task.mapel;
  document.getElementById('judul').value = task.judulTugas;
  document.getElementById('catatan').value = task.materi; // Instruksi as catatan
  document.getElementById('namaGuru').value = task.namaGuru;
  
  // Pre-select kelas if specified in task
  if (task.kelas) {
    document.getElementById('kelas').value = task.kelas;
  }
}

function logout() {
  currentUser = {
    kodeTask: null,
    taskData: null,
    authenticated: false
  };
  
  // Kembali ke halaman login
  document.getElementById('mainSection').classList.remove('active');
  document.getElementById('loginSection').classList.add('active');
  document.getElementById('kodeAccess').value = '';
  
  // Reset form
  resetForm();
}

// === RECORDING ===
async function mulaiRekam() {
  if (!validateForm()) return;

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    
    let options = { mimeType: 'audio/webm;codecs=opus' };
    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
      options = { mimeType: 'audio/webm' };
      if (!MediaRecorder.isTypeSupported(options.mimeType)) {
        options = { mimeType: 'audio/mp4' };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
          options = { mimeType: '' };
        }
      }
    }
    
    mediaRecorder = new MediaRecorder(stream, options);
    audioChunks = [];
    recordingSeconds = 0;
    
    mediaRecorder.ondataavailable = event => {
      audioChunks.push(event.data);
    };
    
    mediaRecorder.onstop = async () => {
      audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
      
      const audioURL = URL.createObjectURL(audioBlob);
      const player = document.getElementById('audioPlayer');
      player.src = audioURL;
      player.classList.add('show');
      
      const sizeKB = (audioBlob.size / 1024).toFixed(2);
      const duration = recordingSeconds;
      document.getElementById('infoDiv').innerHTML = 
        `<div class="info-chip">üìä Ukuran: ${sizeKB} KB | ‚è±Ô∏è Durasi: ${duration}s</div>`;
      
      document.getElementById('btnKirim').disabled = false;
      document.getElementById('statusDiv').innerHTML = 
        '<div class="status-box status-ready">‚úÖ Rekaman siap dikirim!</div>';
      
      clearInterval(timerInterval);
      document.getElementById('timerDiv').innerHTML = '';
      document.getElementById('waveDiv').innerHTML = '';
      
      stream.getTracks().forEach(track => track.stop());
    };
    
    mediaRecorder.start();
    startTimer();
    
    document.getElementById('btnMulai').disabled = true;
    document.getElementById('btnHenti').disabled = false;
    document.getElementById('btnKirim').disabled = true;
    document.getElementById('statusDiv').innerHTML = 
      '<div class="status-box status-recording">üî¥ Sedang merekam...</div>';
    
    document.getElementById('waveDiv').innerHTML = `
      <div class="wave-animation">
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
      </div>
    `;
    
  } catch (err) {
    alert('‚ùå Gagal mengakses mikrofon: ' + err.message);
  }
}

function hentiRekam() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
    document.getElementById('btnMulai').disabled = false;
    document.getElementById('btnHenti').disabled = true;
  }
}

function startTimer() {
  recordingSeconds = 0;
  timerInterval = setInterval(() => {
    recordingSeconds++;
    const minutes = Math.floor(recordingSeconds / 60);
    const seconds = recordingSeconds % 60;
    document.getElementById('timerDiv').innerHTML = 
      `<div class="timer">${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}</div>`;
  }, 1000);
}

function validateForm() {
  const nama = document.getElementById('nama').value.trim();
  const kelas = document.getElementById('kelas').value;
  const absen = document.getElementById('absen').value;
  
  if (!nama) {
    alert('‚ùå Nama lengkap harus diisi!');
    document.getElementById('nama').focus();
    return false;
  }
  if (!kelas) {
    alert('‚ùå Kelas harus dipilih!');
    document.getElementById('kelas').focus();
    return false;
  }
  if (!absen || absen < 1) {
    alert('‚ùå Nomor absen harus diisi!');
    document.getElementById('absen').focus();
    return false;
  }
  
  return true;
}

async function kirimTugas() {
  if (!validateForm()) return;
  if (!audioBlob) {
    alert('‚ùå Belum ada rekaman audio!');
    return;
  }
  
  document.getElementById('btnKirim').disabled = true;
  document.getElementById('statusDiv').innerHTML = 
    '<div class="status-box status-info">‚è≥ Mengirim tugas ke guru...</div>';
  
  try {
    const reader = new FileReader();
    reader.readAsDataURL(audioBlob);
    
    reader.onloadend = async () => {
      const base64Audio = reader.result.split(',')[1];
      
      const payload = {
        type: 'submission',
        kodeTask: currentUser.kodeTask,
        nama: document.getElementById('nama').value.trim(),
        kelas: document.getElementById('kelas').value,
        absen: document.getElementById('absen').value,
        mapel: document.getElementById('mapel').value,
        judul: document.getElementById('judul').value,
        catatan: document.getElementById('catatan').value,
        namaGuru: document.getElementById('namaGuru').value,
        audio: base64Audio,
        mimeType: audioBlob.type,
        ukuran: audioBlob.size,
        durasi: recordingSeconds,
        waktu: new Date().toISOString(),
        status: 'Belum Diperiksa'
      };
      
      const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      // Mode no-cors tidak bisa baca response, jadi assume success
      alert('‚úÖ Tugas berhasil dikirim ke ' + payload.namaGuru + '!');
      resetForm();
      
    };
    
  } catch (err) {
    alert('‚ùå Gagal mengirim: ' + err.message);
    document.getElementById('btnKirim').disabled = false;
  }
}

function resetForm() {
  document.getElementById('nama').value = '';
  document.getElementById('kelas').value = '';
  document.getElementById('absen').value = '';
  document.getElementById('audioPlayer').classList.remove('show');
  document.getElementById('audioPlayer').src = '';
  document.getElementById('infoDiv').innerHTML = '';
  document.getElementById('statusDiv').innerHTML = '';
  document.getElementById('btnKirim').disabled = true;
  document.getElementById('btnMulai').disabled = false;
  audioBlob = null;
}

// Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js').catch(() => {});
}
</script>

</body>

</html>



